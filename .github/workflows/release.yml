name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0-dev'

# ç»™ workflow å†™æƒé™
permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14  # ä½¿ç”¨ Apple Silicon runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Get version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        elif [[ -n "${{ github.event.inputs.version }}" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="1.0.0-dev"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Update version in project
      run: |
        # å¦‚æœ Info.plist å­˜åœ¨ï¼Œæ›´æ–°ç‰ˆæœ¬å·
        if [ -f "Toolbit/Info.plist" ]; then
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.get_version.outputs.VERSION }}" Toolbit/Info.plist 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ github.run_number }}" Toolbit/Info.plist 2>/dev/null || true
        fi
    
    - name: Build application
      run: |
        xcodebuild -project Toolbit.xcodeproj \
          -scheme Toolbit \
          -configuration Release \
          -derivedDataPath build \
          -archivePath build/Toolbit.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          MARKETING_VERSION=${{ steps.get_version.outputs.VERSION }} \
          CURRENT_PROJECT_VERSION=${{ github.run_number }}
    
    - name: Export application
      run: |
        # ä» archive ä¸­æå– app
        mkdir -p build/export
        cp -R build/Toolbit.xcarchive/Products/Applications/Toolbit.app build/export/
        
        # ç§»é™¤ç­¾åç›¸å…³çš„æ‰©å±•å±æ€§
        xattr -cr build/export/Toolbit.app
    
    - name: Create DMG
      run: |
        # åˆ›å»º DMG
        mkdir -p build/dmg
        cp -R build/export/Toolbit.app build/dmg/
        
        # åˆ›å»º Applications å¿«æ·æ–¹å¼
        ln -s /Applications build/dmg/Applications
        
        # åˆ›å»º DMG æ–‡ä»¶
        hdiutil create -volname "Toolbit" \
          -srcfolder build/dmg \
          -ov -format UDZO \
          build/Toolbit-${{ steps.get_version.outputs.VERSION }}.dmg
    
    - name: Create ZIP
      run: |
        cd build/export
        zip -r ../Toolbit-${{ steps.get_version.outputs.VERSION }}.zip Toolbit.app
    
    - name: Calculate checksums
      id: checksums
      run: |
        cd build
        DMG_SHA256=$(shasum -a 256 Toolbit-${{ steps.get_version.outputs.VERSION }}.dmg | awk '{print $1}')
        ZIP_SHA256=$(shasum -a 256 Toolbit-${{ steps.get_version.outputs.VERSION }}.zip | awk '{print $1}')
        echo "DMG_SHA256=$DMG_SHA256" >> $GITHUB_OUTPUT
        echo "ZIP_SHA256=$ZIP_SHA256" >> $GITHUB_OUTPUT
        echo "DMG SHA256: $DMG_SHA256"
        echo "ZIP SHA256: $ZIP_SHA256"
    
    - name: Update Homebrew Cask
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # æ›´æ–° Cask æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å’Œ SHA256
        VERSION=${{ steps.get_version.outputs.VERSION }}
        SHA256=${{ steps.checksums.outputs.ZIP_SHA256 }}
        
        # æ›´æ–°ç‰ˆæœ¬å·
        sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Casks/toolbit.rb
        
        # æ›´æ–° SHA256
        sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/toolbit.rb
        
        echo "Updated Casks/toolbit.rb:"
        cat Casks/toolbit.rb
    
    - name: Commit Cask update
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        VERSION=${{ steps.get_version.outputs.VERSION }}
        SHA256=${{ steps.checksums.outputs.ZIP_SHA256 }}
        
        # ä¿å­˜æ›´æ–°åçš„ Cask å†…å®¹
        CASK_CONTENT=$(cat Casks/toolbit.rb)
        
        # åˆ‡æ¢åˆ° main åˆ†æ”¯ï¼ˆä¸¢å¼ƒæœ¬åœ°æ›´æ”¹ï¼‰
        git fetch origin main
        git checkout -f main
        
        # é‡æ–°å†™å…¥æ›´æ–°åçš„ Cask æ–‡ä»¶
        echo "$CASK_CONTENT" > Casks/toolbit.rb
        
        # æˆ–è€…ç›´æ¥ç”¨ sed æ›´æ–°
        sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Casks/toolbit.rb 2>/dev/null || \
        sed -i "s/version \".*\"/version \"${VERSION}\"/" Casks/toolbit.rb
        
        sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/toolbit.rb 2>/dev/null || \
        sed -i "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/toolbit.rb
        
        # æäº¤æ›´æ”¹
        git add Casks/toolbit.rb
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: update Cask to v${VERSION}"
          git push origin main
        fi
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          build/Toolbit-${{ steps.get_version.outputs.VERSION }}.dmg
          build/Toolbit-${{ steps.get_version.outputs.VERSION }}.zip
        body: |
          ## Toolbit v${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸ“¥ ä¸‹è½½
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | `Toolbit-${{ steps.get_version.outputs.VERSION }}.dmg` | DMG å®‰è£…åŒ…ï¼ˆæ¨èï¼‰ |
          | `Toolbit-${{ steps.get_version.outputs.VERSION }}.zip` | ZIP å‹ç¼©åŒ… |
          
          ### ğŸš€ å®‰è£…æ–¹å¼
          
          #### æ–¹å¼ä¸€ï¼šHomebrew å®‰è£…ï¼ˆæ¨èï¼‰
          ```bash
          # é¦–æ¬¡å®‰è£…
          brew tap young-bo-i/toolbit https://github.com/young-bo-i/toolbit.git
          brew install --cask toolbit
          
          # æ›´æ–°ç‰ˆæœ¬
          brew upgrade --cask toolbit
          ```
          
          #### æ–¹å¼äºŒï¼šDMG å®‰è£…
          1. ä¸‹è½½ DMG æ–‡ä»¶
          2. åŒå‡»æ‰“å¼€ DMG
          3. å°† Toolbit æ‹–åˆ° Applications æ–‡ä»¶å¤¹
          4. é¦–æ¬¡æ‰“å¼€éœ€è¦åœ¨ã€Œç³»ç»Ÿè®¾ç½® â†’ éšç§ä¸å®‰å…¨æ€§ã€ä¸­å…è®¸
          
          #### æ–¹å¼ä¸‰ï¼šåº”ç”¨å†…æ›´æ–°
          æ‰“å¼€ Toolbit â†’ èœå•æ  â†’ æ£€æŸ¥æ›´æ–°
          
          ### ğŸ” æ ¡éªŒå’Œ
          | æ–‡ä»¶ | SHA256 |
          |------|--------|
          | DMG | `${{ steps.checksums.outputs.DMG_SHA256 }}` |
          | ZIP | `${{ steps.checksums.outputs.ZIP_SHA256 }}` |
          
          ### ğŸ“‹ æ›´æ–°è¯´æ˜
          <!-- è¯·åœ¨æ­¤å¤„æ·»åŠ æ›´æ–°è¯´æ˜ -->
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts (for manual builds)
      uses: actions/upload-artifact@v4
      if: "!startsWith(github.ref, 'refs/tags/')"
      with:
        name: Toolbit-${{ steps.get_version.outputs.VERSION }}
        path: |
          build/Toolbit-${{ steps.get_version.outputs.VERSION }}.dmg
          build/Toolbit-${{ steps.get_version.outputs.VERSION }}.zip
