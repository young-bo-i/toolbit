name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 当推送 v 开头的 tag 时触发，如 v1.0.0
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Get version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="1.0.0-dev"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Update version in project
      run: |
        # 更新 Info.plist 中的版本号
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.get_version.outputs.VERSION }}" DevToolbox/Info.plist 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ github.run_number }}" DevToolbox/Info.plist 2>/dev/null || true
    
    - name: Build application
      run: |
        xcodebuild -project DevToolbox.xcodeproj \
          -scheme DevToolbox \
          -configuration Release \
          -derivedDataPath build \
          -archivePath build/DevToolbox.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Export application
      run: |
        # 从 archive 中提取 app
        mkdir -p build/export
        cp -R build/DevToolbox.xcarchive/Products/Applications/DevToolbox.app build/export/
        
        # 移除签名相关的扩展属性
        xattr -cr build/export/DevToolbox.app
    
    - name: Create DMG
      run: |
        # 创建 DMG
        mkdir -p build/dmg
        cp -R build/export/DevToolbox.app build/dmg/
        
        # 创建 Applications 快捷方式
        ln -s /Applications build/dmg/Applications
        
        # 创建 DMG 文件
        hdiutil create -volname "DevToolbox" \
          -srcfolder build/dmg \
          -ov -format UDZO \
          build/DevToolbox-${{ steps.get_version.outputs.VERSION }}.dmg
    
    - name: Create ZIP
      run: |
        cd build/export
        zip -r ../DevToolbox-${{ steps.get_version.outputs.VERSION }}.zip DevToolbox.app
    
    - name: Calculate checksums
      id: checksums
      run: |
        cd build
        DMG_SHA256=$(shasum -a 256 DevToolbox-${{ steps.get_version.outputs.VERSION }}.dmg | awk '{print $1}')
        ZIP_SHA256=$(shasum -a 256 DevToolbox-${{ steps.get_version.outputs.VERSION }}.zip | awk '{print $1}')
        echo "DMG_SHA256=$DMG_SHA256" >> $GITHUB_OUTPUT
        echo "ZIP_SHA256=$ZIP_SHA256" >> $GITHUB_OUTPUT
        echo "DMG SHA256: $DMG_SHA256"
        echo "ZIP SHA256: $ZIP_SHA256"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          build/DevToolbox-${{ steps.get_version.outputs.VERSION }}.dmg
          build/DevToolbox-${{ steps.get_version.outputs.VERSION }}.zip
        body: |
          ## DevToolbox v${{ steps.get_version.outputs.VERSION }}
          
          ### 下载
          - **DMG 安装包**: `DevToolbox-${{ steps.get_version.outputs.VERSION }}.dmg`
          - **ZIP 压缩包**: `DevToolbox-${{ steps.get_version.outputs.VERSION }}.zip`
          
          ### 安装方式
          
          #### 方式一：DMG 安装
          1. 下载 DMG 文件
          2. 双击打开 DMG
          3. 将 DevToolbox 拖到 Applications 文件夹
          4. 首次打开需要在「系统设置 → 隐私与安全」中允许
          
          #### 方式二：Homebrew 安装
          ```bash
          brew install --cask devtoolbox
          ```
          
          ### 校验和
          - DMG SHA256: `${{ steps.checksums.outputs.DMG_SHA256 }}`
          - ZIP SHA256: `${{ steps.checksums.outputs.ZIP_SHA256 }}`
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts (for manual builds)
      uses: actions/upload-artifact@v4
      if: "!startsWith(github.ref, 'refs/tags/')"
      with:
        name: DevToolbox-${{ steps.get_version.outputs.VERSION }}
        path: |
          build/DevToolbox-${{ steps.get_version.outputs.VERSION }}.dmg
          build/DevToolbox-${{ steps.get_version.outputs.VERSION }}.zip

