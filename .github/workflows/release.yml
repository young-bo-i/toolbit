name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0-dev'

# ç»™ workflow å†™æƒé™
permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14  # ä½¿ç”¨ Apple Silicon runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Get version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        elif [[ -n "${{ github.event.inputs.version }}" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="1.0.0-dev"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Update version in project
      run: |
        # å¦‚æœ Info.plist å­˜åœ¨ï¼Œæ›´æ–°ç‰ˆæœ¬å·
        if [ -f "Toolbit/Info.plist" ]; then
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.get_version.outputs.VERSION }}" Toolbit/Info.plist 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ github.run_number }}" Toolbit/Info.plist 2>/dev/null || true
        fi
    
    - name: Build application
      run: |
        xcodebuild -project Toolbit.xcodeproj \
          -scheme Toolbit \
          -configuration Release \
          -derivedDataPath build \
          -archivePath build/Toolbit.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES \
          MARKETING_VERSION=${{ steps.get_version.outputs.VERSION }} \
          CURRENT_PROJECT_VERSION=${{ github.run_number }}
    
    - name: Export and sign application
      run: |
        # ä» archive ä¸­æå– app
        mkdir -p build/export
        cp -R build/Toolbit.xcarchive/Products/Applications/Toolbit.app build/export/
        
        # ä½¿ç”¨ ad-hoc ç­¾åï¼ˆå…è®¸åœ¨æœ¬åœ°è¿è¡Œï¼‰
        codesign --force --deep --sign - build/export/Toolbit.app
        
        # éªŒè¯ç­¾å
        codesign --verify --verbose build/export/Toolbit.app || true
        
        # ç§»é™¤éš”ç¦»å±æ€§
        xattr -cr build/export/Toolbit.app
    
    - name: Create DMG
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        APP_NAME="Toolbit"
        DMG_TEMP="build/dmg-temp"
        DMG_BACKGROUND="scripts/dmg-resources/background.png"
        
        # æ¸…ç†å¹¶åˆ›å»ºä¸´æ—¶ç›®å½•
        rm -rf "${DMG_TEMP}"
        mkdir -p "${DMG_TEMP}"
        
        # å¤åˆ¶åº”ç”¨å’Œåˆ›å»ºå¿«æ·æ–¹å¼
        cp -R build/export/Toolbit.app "${DMG_TEMP}/"
        ln -s /Applications "${DMG_TEMP}/Applications"
        
        # å¤åˆ¶èƒŒæ™¯å›¾ç‰‡
        if [ -f "${DMG_BACKGROUND}" ]; then
            mkdir -p "${DMG_TEMP}/.background"
            cp "${DMG_BACKGROUND}" "${DMG_TEMP}/.background/background.png"
        fi
        
        # è®¡ç®— DMG å¤§å°
        APP_SIZE=$(du -sm "${DMG_TEMP}" | cut -f1)
        DMG_SIZE=$((APP_SIZE + 20))
        
        # åˆ›å»ºä¸´æ—¶å¯å†™ DMG
        hdiutil create -srcfolder "${DMG_TEMP}" \
            -volname "${APP_NAME}" \
            -fs HFS+ \
            -fsargs "-c c=64,a=16,e=16" \
            -format UDRW \
            -size ${DMG_SIZE}m \
            "build/${APP_NAME}-temp.dmg"
        
        # æŒ‚è½½ DMG
        MOUNT_DIR=$(hdiutil attach -readwrite -noverify -noautoopen "build/${APP_NAME}-temp.dmg" | grep "/Volumes/" | sed 's/.*\/Volumes/\/Volumes/')
        sleep 2
        
        # ä½¿ç”¨ AppleScript è®¾ç½®çª—å£æ ·å¼
        osascript << EOF
        tell application "Finder"
            tell disk "${APP_NAME}"
                open
                set current view of container window to icon view
                set toolbar visible of container window to false
                set statusbar visible of container window to false
                set the bounds of container window to {400, 100, 920, 480}
                set viewOptions to the icon view options of container window
                set arrangement of viewOptions to not arranged
                set icon size of viewOptions to 100
                set background picture of viewOptions to file ".background:background.png"
                set position of item "${APP_NAME}.app" of container window to {140, 185}
                set position of item "Applications" of container window to {380, 185}
                close
                open
                update without registering applications
                delay 2
            end tell
        end tell
        EOF
        
        # å¸è½½å¹¶è½¬æ¢
        sync
        hdiutil detach "${MOUNT_DIR}"
        hdiutil convert "build/${APP_NAME}-temp.dmg" \
            -format UDZO \
            -imagekey zlib-level=9 \
            -o "build/Toolbit-${VERSION}.dmg"
        
        # æ¸…ç†
        rm -f "build/${APP_NAME}-temp.dmg"
        rm -rf "${DMG_TEMP}"
    
    - name: Create ZIP
      run: |
        cd build/export
        zip -r ../Toolbit-${{ steps.get_version.outputs.VERSION }}.zip Toolbit.app
    
    - name: Calculate checksums
      id: checksums
      run: |
        cd build
        DMG_SHA256=$(shasum -a 256 Toolbit-${{ steps.get_version.outputs.VERSION }}.dmg | awk '{print $1}')
        ZIP_SHA256=$(shasum -a 256 Toolbit-${{ steps.get_version.outputs.VERSION }}.zip | awk '{print $1}')
        echo "DMG_SHA256=$DMG_SHA256" >> $GITHUB_OUTPUT
        echo "ZIP_SHA256=$ZIP_SHA256" >> $GITHUB_OUTPUT
        echo "DMG SHA256: $DMG_SHA256"
        echo "ZIP SHA256: $ZIP_SHA256"
    
    - name: Update Homebrew Cask
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # æ›´æ–° Cask æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å’Œ SHA256
        VERSION=${{ steps.get_version.outputs.VERSION }}
        SHA256=${{ steps.checksums.outputs.ZIP_SHA256 }}
        
        # æ›´æ–°ç‰ˆæœ¬å·
        sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Casks/toolbit.rb
        
        # æ›´æ–° SHA256
        sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/toolbit.rb
        
        echo "Updated Casks/toolbit.rb:"
        cat Casks/toolbit.rb
    
    - name: Commit Cask update
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        VERSION=${{ steps.get_version.outputs.VERSION }}
        SHA256=${{ steps.checksums.outputs.ZIP_SHA256 }}
        
        # ä¿å­˜æ›´æ–°åçš„ Cask å†…å®¹
        CASK_CONTENT=$(cat Casks/toolbit.rb)
        
        # åˆ‡æ¢åˆ° main åˆ†æ”¯ï¼ˆä¸¢å¼ƒæœ¬åœ°æ›´æ”¹ï¼‰
        git fetch origin main
        git checkout -f main
        
        # é‡æ–°å†™å…¥æ›´æ–°åçš„ Cask æ–‡ä»¶
        echo "$CASK_CONTENT" > Casks/toolbit.rb
        
        # æˆ–è€…ç›´æ¥ç”¨ sed æ›´æ–°
        sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Casks/toolbit.rb 2>/dev/null || \
        sed -i "s/version \".*\"/version \"${VERSION}\"/" Casks/toolbit.rb
        
        sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/toolbit.rb 2>/dev/null || \
        sed -i "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/toolbit.rb
        
        # æäº¤æ›´æ”¹
        git add Casks/toolbit.rb
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: update Cask to v${VERSION}"
          git push origin main
        fi
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          build/Toolbit-${{ steps.get_version.outputs.VERSION }}.dmg
          build/Toolbit-${{ steps.get_version.outputs.VERSION }}.zip
        body: |
          ## Toolbit v${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸ“¥ ä¸‹è½½
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | `Toolbit-${{ steps.get_version.outputs.VERSION }}.dmg` | DMG å®‰è£…åŒ…ï¼ˆæ¨èï¼‰ |
          | `Toolbit-${{ steps.get_version.outputs.VERSION }}.zip` | ZIP å‹ç¼©åŒ… |
          
          ### ğŸš€ å®‰è£…æ–¹å¼
          
          #### æ–¹å¼ä¸€ï¼šHomebrew å®‰è£…ï¼ˆæ¨èï¼‰
          ```bash
          # é¦–æ¬¡å®‰è£…
          brew tap young-bo-i/toolbit https://github.com/young-bo-i/toolbit.git
          brew install --cask toolbit
          
          # æ›´æ–°ç‰ˆæœ¬
          brew upgrade --cask toolbit
          ```
          
          #### æ–¹å¼äºŒï¼šDMG å®‰è£…
          1. ä¸‹è½½ DMG æ–‡ä»¶
          2. åŒå‡»æ‰“å¼€ DMG
          3. å°† Toolbit æ‹–åˆ° Applications æ–‡ä»¶å¤¹
          4. å¦‚æœæç¤º"åº”ç”¨å·²æŸå"ï¼Œè¯·åœ¨ç»ˆç«¯è¿è¡Œï¼š
          ```bash
             sudo xattr -cr /Applications/Toolbit.app
          ```
          
          #### æ–¹å¼ä¸‰ï¼šåº”ç”¨å†…æ›´æ–°
          æ‰“å¼€ Toolbit â†’ èœå•æ  â†’ æ£€æŸ¥æ›´æ–°
          
          ### ğŸ” æ ¡éªŒå’Œ
          | æ–‡ä»¶ | SHA256 |
          |------|--------|
          | DMG | `${{ steps.checksums.outputs.DMG_SHA256 }}` |
          | ZIP | `${{ steps.checksums.outputs.ZIP_SHA256 }}` |
          
          ### ğŸ“‹ æ›´æ–°è¯´æ˜
          <!-- è¯·åœ¨æ­¤å¤„æ·»åŠ æ›´æ–°è¯´æ˜ -->
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts (for manual builds)
      uses: actions/upload-artifact@v4
      if: "!startsWith(github.ref, 'refs/tags/')"
      with:
        name: Toolbit-${{ steps.get_version.outputs.VERSION }}
        path: |
          build/Toolbit-${{ steps.get_version.outputs.VERSION }}.dmg
          build/Toolbit-${{ steps.get_version.outputs.VERSION }}.zip
